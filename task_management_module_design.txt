
================================================================================
LARAVEL TASK MANAGEMENT MODULE - PRODUCTION DESIGN
================================================================================

1. ARCHITECTURE & FOLDER STRUCTURE
--------------------------------------------------------------------------------
This module follows the existing modular architecture in `app/Modul/`.

app/
  Modul/
    Task/
      Database/
        Migrations/
          2026_01_22_000000_create_tasks_table.php
      Http/
        Controllers/
          Api/
            TaskApiController.php
          TaskController.php
      Model/
        Task.php
        TaskActivity.php
      Services/
        TaskService.php
        AiTaskGenerator.php
      Events/
        TaskCreated.php
        TaskSlaBreached.php
      Listeners/
        AutoGenerateFromTicket.php
      Policies/
        TaskPolicy.php
      Rute/
        api.php
        web.php
      TaskServiceProvider.php
      manifest.json

2. DATABASE SCHEMA (MIGRATION)
--------------------------------------------------------------------------------
File: app/Modul/Task/Database/Migrations/2026_01_22_000000_create_tasks_table.php

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('tasks', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            
            // Core Details
            $table->string('title');
            $table->text('description')->nullable();
            $table->enum('status', ['pending', 'in_progress', 'blocked', 'review', 'done', 'cancelled'])->default('pending')->index();
            $table->enum('priority', ['low', 'medium', 'high', 'urgent'])->default('medium')->index();
            
            // Ownership & Assignment
            $table->foreignId('assigned_to')->nullable()->constrained('pengguna')->nullOnDelete();
            $table->foreignId('created_by')->nullable()->constrained('pengguna')->nullOnDelete();
            $table->foreignId('team_id')->nullable(); // For Team assignment
            
            // Relationships (Polymorphic or Direct)
            // Using direct keys for better integrity as requested
            $table->foreignId('tiket_id')->nullable()->constrained('tikets')->nullOnDelete();
            $table->integer('chat_session_id')->nullable()->index(); // Assuming chat ID is integer
            $table->foreignId('parent_task_id')->nullable()->constrained('tasks')->nullOnDelete();
            
            // Timing & SLA
            $table->timestamp('due_at')->nullable();
            $table->timestamp('sla_at')->nullable();
            $table->timestamp('started_at')->nullable();
            $table->timestamp('completed_at')->nullable();
            
            // AI Integration
            $table->boolean('is_ai_generated')->default(false);
            $table->json('ai_metadata')->nullable(); // Stores reasoning, confidence score, original intent
            
            $table->timestamps();
            $table->softDeletes();
        });

        Schema::create('task_activities', function (Blueprint $table) {
            $table->id();
            $table->foreignId('task_id')->constrained('tasks')->cascadeOnDelete();
            $table->foreignId('user_id')->nullable()->constrained('pengguna');
            $table->string('action'); // 'created', 'status_change', 'comment', 'sla_breach'
            $table->text('details')->nullable();
            $table->json('changes')->nullable(); // Before/After values
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('task_activities');
        Schema::dropIfExists('tasks');
    }
};

3. LARAVEL API ROUTES
--------------------------------------------------------------------------------
File: app/Modul/Task/Rute/api.php

<?php

use Illuminate\Support\Facades\Route;
use App\Modul\Task\Http\Controllers\Api\TaskApiController;

Route::middleware(['auth:sanctum', 'api'])->prefix('v1/tasks')->group(function () {
    // Core CRUD
    Route::get('/', [TaskApiController::class, 'index']);
    Route::post('/', [TaskApiController::class, 'store']);
    Route::get('/{uuid}', [TaskApiController::class, 'show']);
    Route::put('/{uuid}', [TaskApiController::class, 'update']);
    Route::delete('/{uuid}', [TaskApiController::class, 'destroy']);

    // Actions
    Route::post('/{uuid}/assign', [TaskApiController::class, 'assign']);
    Route::post('/{uuid}/status', [TaskApiController::class, 'updateStatus']);
    Route::post('/generate-ai', [TaskApiController::class, 'generateFromAi']); // Manual trigger for AI analysis
});

4. DATA MODELS
--------------------------------------------------------------------------------
File: app/Modul/Task/Model/Task.php

<?php

namespace App\Modul\Task\Model;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use App\Modul\Tiket\Model\Tiket;
use App\Models\User;

class Task extends Model
{
    use HasFactory, SoftDeletes;

    protected $guarded = ['id'];
    
    protected $casts = [
        'due_at' => 'datetime',
        'sla_at' => 'datetime',
        'started_at' => 'datetime',
        'completed_at' => 'datetime',
        'ai_metadata' => 'array',
        'is_ai_generated' => 'boolean',
    ];

    // Relationships
    public function assignee() {
        return $this->belongsTo(User::class, 'assigned_to');
    }

    public function creator() {
        return $this->belongsTo(User::class, 'created_by');
    }

    public function tiket() {
        return $this->belongsTo(Tiket::class, 'tiket_id');
    }

    public function activities() {
        return $this->hasMany(TaskActivity::class)->latest();
    }

    public function subtasks() {
        return $this->hasMany(Task::class, 'parent_task_id');
    }

    // Scopes
    public function scopePending($query) {
        return $query->whereIn('status', ['pending', 'in_progress']);
    }

    public function scopeOverdue($query) {
        return $query->where('due_at', '<', now())->whereNull('completed_at');
    }
}

5. CORE SERVICES & AI LOGIC
--------------------------------------------------------------------------------
File: app/Modul/Task/Services/AiTaskGenerator.php

<?php

namespace App\Modul\Task\Services;

use App\Modul\Task\Model\Task;
use App\Modul\Tiket\Model\Tiket;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Log;

class AiTaskGenerator
{
    /**
     * Analyze text input (Chat or Ticket) and propose Tasks
     */
    public function analyzeAndProposeTasks($content, $sourceType, $sourceId)
    {
        // 1. Construct Prompt for LLM
        $prompt = "Analyze the following support request and extract actionable tasks.
                   Return JSON format with: title, description, priority (low/med/high), suggested_due_hours.
                   
                   Context: $sourceType #$sourceId
                   Content: $content";

        // 2. Call LLM Service (Mocked here - replace with actual OpenAI/Gemini call)
        $aiResponse = $this->callLLM($prompt);

        // 3. Process Response
        $tasksToCreate = [];
        foreach ($aiResponse['tasks'] as $pTask) {
             $tasksToCreate[] = [
                 'title' => $pTask['title'],
                 'description' => $pTask['description'],
                 'priority' => $pTask['priority'],
                 'due_at' => now()->addHours($pTask['suggested_due_hours']),
                 'source_type' => $sourceType,
                 'source_id' => $sourceId,
                 'ai_metadata' => ['confidence' => 0.95, 'reasoning' => 'Detected distinct action item']
             ];
        }

        return $tasksToCreate;
    }

    public function createFromTiket(Tiket $tiket)
    {
        // Auto-generation logic trigger
        $tasks = $this->analyzeAndProposeTasks(
            $tiket->deskripsi ?? 'No description', // Adjust field name based on Tiket model
            'ticket',
            $tiket->id
        );

        foreach ($tasks as $data) {
            Task::create([
                'uuid' => Str::uuid(),
                'title' => $data['title'],
                'description' => $data['description'],
                'priority' => $data['priority'],
                'status' => 'pending',
                'due_at' => $data['due_at'],
                'tiket_id' => $data['source_id'],
                'is_ai_generated' => true,
                'ai_metadata' => $data['ai_metadata']
            ]);
        }
    }

    private function callLLM($prompt) {
        // Pseudo-code for LLM integration
        // return OpenAI::chat()->create(...)
        return [
            'tasks' => [
               [
                   'title' => 'Investigate Issue', 
                   'description' => 'Check server logs based on ticket.', 
                   'priority' => 'high', 
                   'suggested_due_hours' => 4
               ]
            ]
        ];
    }
}

File: app/Modul/Task/Services/TaskService.php

<?php

namespace App\Modul\Task\Services;

use App\Modul\Task\Model\Task;
use App\Modul\Task\Model\TaskActivity;
use Illuminate\Support\Facades\DB;

class TaskService
{
    public function updateStatus(Task $task, string $status, int $userId)
    {
        return DB::transaction(function () use ($task, $status, $userId) {
            $oldStatus = $task->status;
            $task->update([
                'status' => $status,
                'started_at' => ($status === 'in_progress' && !$task->started_at) ? now() : $task->started_at,
                'completed_at' => ($status === 'done') ? now() : null,
            ]);

            TaskActivity::create([
                'task_id' => $task->id,
                'user_id' => $userId,
                'action' => 'status_change',
                'details' => "Changed status from $oldStatus to $status",
                'changes' => json_encode(['from' => $oldStatus, 'to' => $status])
            ]);
            
            // Check for Auto-KB generation if Done
            if ($status === 'done') {
                // Event::dispatch(new TaskCompleted($task));
            }

            return $task; 
        });
    }
}

6. CONTROLLERS
--------------------------------------------------------------------------------
File: app/Modul/Task/Http/Controllers/Api/TaskApiController.php

<?php

namespace App\Modul\Task\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Modul\Task\Model\Task;
use App\Modul\Task\Services\TaskService;
use App\Modul\Task\Services\AiTaskGenerator;
use Illuminate\Http\Request;

class TaskApiController extends Controller
{
    protected $taskService;
    protected $aiGenerator;

    public function __construct(TaskService $taskService, AiTaskGenerator $aiGenerator)
    {
        $this->taskService = $taskService;
        $this->aiGenerator = $aiGenerator;
    }

    public function index(Request $request)
    {
        $query = Task::query();
        
        if ($request->has('status')) {
            $query->where('status', $request->status);
        }
        if ($request->has('assigned_to')) {
            $query->where('assigned_to', $request->assigned_to);
        }
        
        return response()->json($query->paginate(20));
    }

    public function store(Request $request)
    {
        $validated = $request->validate([
            'title' => 'required|string|max:255',
            'priority' => 'required|in:low,medium,high,urgent',
            'ticket_id' => 'nullable|exists:tikets,id'
        ]);

        $task = Task::create(array_merge($validated, [
            'uuid' => (string) \Illuminate\Support\Str::uuid(),
            'created_by' => auth()->id(),
            'status' => 'pending'
        ]));

        return response()->json($task, 201);
    }
    
    // ... implement other CRUD methods ...
}

7. SECURITY & PERMISSIONS
--------------------------------------------------------------------------------
Uses Laravel Roles/Permissions (spatie or custom as per 'core_migration' - `izin` table).
Seed the following `izin`:
- `view-tasks`
- `create-tasks`
- `edit-tasks`
- `delete-tasks`
- `assign-tasks`

8. END-TO-END LIFECYCLE EXAMPLE
--------------------------------------------------------------------------------
Scenario: Server Down Ticket

1. [User] creates Ticket #101 via Chat: "My server is unreachable."
2. [System] 'TicketCreated' Event fires.
3. [Listener] 'AutoGenerateFromTicket' catches event, calls 'AiTaskGenerator'.
4. [AI] analyzes "server unreachable".
   - Identifies intent: "Technical Issue".
   - Generates Task: "Diagnose Server Connectivity" (Priority: High).
5. [Database] Task created:
   - Status: Pending
   - Linked to Ticket #101
   - SLA: 4 hours
6. [Admin] sees Task in Dashboard. Assigns to [DevOps Agent].
7. [DevOps Agent] moves Task to "In Progress".
8. [DevOps Agent] fixes issue, updates Task notes, moves to "Done".
9. [System] updates Ticket #101 status to "Resolved" (optional automation).
10. [System] Suggests creating KB Article: "Troubleshooting Unreachable Servers".

